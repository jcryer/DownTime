<!DOCTYPE html>
<html>
<head>
	<script>
		class Melon {
			constructor(){
				this.x = WIDTH/2;
				this.y = 0;
				this.vel = 10;
				this.jumped = false;

			}

			update(){
				if(this.y > 1 && this.jumped == true && this.vel < 0){
					this.jumped = false;
				}

				if(this.y > 0){
					this.vel += -0.5;
				}else{
					this.vel += -this.y/100
				}
				this.y += this.vel;
				this.vel *= 0.999;
			}

			applyJump(){
				if(this.y <= 0 && this.jumped == false){
					this.vel += 5*(1-1*Math.pow(Math.E,this.y*0.5));
					//console.log("JUMPED");
				}

				this.jumped = true;
			}

			draw(){
				/*
				ctx.beginPath();
				ctx.fillStyle = "#FFFF00";
				ctx.arc(this.x, groundHeight, 20, 0, 2 * Math.PI);
				ctx.fill();
				ctx.stroke();
				*/

				ctx.drawImage(melonManImg, this.x-40, groundHeight-40, 80,80);
			}

			getY(){
				return this.y;
			}


		}

		class staticSprite {
			constructor(startX,startY, offX, offY, sizeX, sizeY){
				this.x = startX;
				this.y = startY;	
				this.sX = sizeX;
				this.sY = sizeY;		
			}

			draw(){
				ctx.drawImage(cloudImg, this.x, -this.y+camY,this.sX,this.sY);
			}

			update(){
			}
		}

		function calcBlue(height){
			var digits = "0123456789ABCDEF";
			if(height < 0){
				return "FF";
			}
			var dec = parseInt(255*height/1000);
			if(dec > 255){
				dec = 255;
			}
			var hexDig1 = 15-(parseInt(dec/16));
			var hexDig2 = 15-(dec-16*parseInt(dec/16));

			return (digits[hexDig1].toString() + digits[hexDig2].toString());
		}

		function mainLoop(){
			camY = melon.getY();



		    ctx.fillStyle = "#0000"+calcBlue(melon.getY());

			ctx.fillRect(0,0,WIDTH,HEIGHT);

			ctx.fillStyle = "#00FF00";

			ctx.fillRect(0,camY+groundHeight+50,WIDTH,10000);
			
			ctx.fillStyle = "#DD8844";

			ctx.fillRect(0,camY+groundHeight+80,WIDTH,10000);
			
			ctx.fillStyle = "#000000";
			if(melon.getY()-10 <= 0){
				ctx.beginPath();
				ctx.moveTo(0, groundHeight+camY);
				ctx.lineTo(WIDTH/2-20, groundHeight);
				ctx.stroke();
				ctx.beginPath();
				ctx.lineTo(WIDTH/2+20, groundHeight);
				ctx.lineTo(WIDTH, groundHeight+camY);
				ctx.stroke();
			}else{
				ctx.beginPath();
				ctx.moveTo(0, groundHeight+camY);
				ctx.lineTo(WIDTH, groundHeight+camY);
				ctx.stroke();
			}

			for(var i = 0; i < clouds.length; i++){
				clouds[i].draw()
			}

			for(var i = 0; i < trees.length; i++){
				trees[i].draw();
			}

			//melon.applyJump();
		    melon.update();

			melon.draw();

		    if(true){
		        requestAnimationFrame(mainLoop);
		    }
		}

		function keyDown(e) {
			melon.applyJump();
		}

		var canvas;
		var ctx;
		const groundHeight = 300;
		const WIDTH = 640;
		const HEIGHT = 480;
		var camY = 0;

		var cloudImg = new Image();
		var melonManImg = new Image();
		var treeImg = new Image();

		melonManImg.src = "MelonBall.png";

		cloudImg.src = "cloud.png";

		var clouds = [];
		clouds.push(new staticSprite(100,300,200,200));
		clouds.push(new staticSprite(300,500,200,200));

		var trees = [];
		trees.push(new staticSprite(10,0,100,100));
		trees.push(new staticSprite(200,0,100,100));
		trees.push(new staticSprite(300,0,100,100));
		trees.push(new staticSprite(400,0,100,100));

		var melon = new Melon();

	</script> 
</head>
<body>

	<canvas id="myCanvas"  width="640" height="480"></canvas>
	<script type="text/javascript">
		canvas = document.getElementById("myCanvas");
		window.addEventListener( "keydown", this.keyDown, true);
		ctx = canvas.getContext("2d");
		
		requestAnimationFrame(mainLoop);
	</script>
</body>
</html>